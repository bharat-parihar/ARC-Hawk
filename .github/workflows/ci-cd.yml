name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ==================== LINT & TEST ====================
  lint-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Download dependencies
        run: go mod download
        working-directory: apps/backend

      - name: Run Go Vet
        run: go vet ./...
        working-directory: apps/backend

      - name: Run Go Tests
        run: go test ./... -short
        working-directory: apps/backend

  lint-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: apps/frontend

      - name: Run ESLint
        run: npm run lint
        working-directory: apps/frontend

  lint-scanner:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
          cache-dependency-path: apps/scanner/requirements.txt

      - name: Install dependencies
        run: pip install -r apps/scanner/requirements.txt
        working-directory: .

      - name: Run Python Lint
        run: |
          pip install flake8
          flake8 apps/scanner --max-line-length=100

  # ==================== BUILD ====================
  build-backend:
    needs: lint-backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Backend Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend
          push: false
          load: true
          tags: arc-hawk-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-frontend:
    needs: lint-frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Frontend Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/frontend
          push: false
          load: true
          tags: arc-hawk-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-scanner:
    needs: lint-scanner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Scanner Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/scanner
          push: false
          load: true
          tags: arc-hawk-scanner:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==================== INTEGRATION TESTS ====================
  integration-tests:
    needs: [build-backend, build-frontend, build-scanner]
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: arc_platform
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      neo4j:
        image: neo4j:5.15-community
        env:
          NEO4J_AUTH: neo4j/password123
        ports:
          - 7474:7474
          - 7687:7687
        options: >-
          --health-cmd "cypher-shell -u neo4j -p password123 RETURN 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Wait for services
        run: |
          echo "Waiting for PostgreSQL..."
          timeout 60 bash -c 'until pg_isready -h localhost -p 5432; do sleep 2; done'
          echo "PostgreSQL ready!"
          echo "Waiting for Neo4j..."
          timeout 60 bash -c 'until cypher-shell -u neo4j -p password123 -a localhost -d neo4j "RETURN 1" 2>/dev/null; do sleep 2; done'
          echo "Neo4j ready!"

      - name: Run Integration Tests
        run: |
          cd apps/backend
          go test ./... -tags=integration -v
        env:
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          DATABASE_USER: postgres
          DATABASE_PASSWORD: postgres
          DATABASE_NAME: arc_platform
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: password123

  # ==================== DOCKER HUB PUSH ====================
  push-images:
    needs: [build-backend, build-frontend, build-scanner, integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/arc-hawk-backend
          tags: |
            type=ref,event=branch
            type=sha

      - name: Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.annotations }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/arc-hawk-frontend
          tags: |
            type=ref,event=branch
            type=sha

      - name: Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.annotations }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract metadata for Scanner
        id: meta-scanner
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/arc-hawk-scanner
          tags: |
            type=ref,event=branch
            type=sha

      - name: Push Scanner Image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/scanner
          push: true
          tags: ${{ steps.meta-scanner.outputs.tags }}
          labels: ${{ steps.meta-scanner.outputs.annotations }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==================== DEPLOY (Manual Trigger) ====================
  deploy:
    needs: push-images
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/arc-hawk
            git pull origin main
            docker-compose pull
            docker-compose up -d --build
            echo "Deployment complete!"
