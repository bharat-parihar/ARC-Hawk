name: Regression Tests
on: 
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  regression:
    runs-on: ubuntu-latest
    
    services:
      presidio:
        image: mcr.microsoft.com/presidio-analyzer:latest
        ports:
          - 5001:3000
        options: >-
          --health-cmd "curl -f http://localhost:3000/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Wait for Presidio to be ready
        run: |
          echo "Waiting for Presidio service..."
          timeout 60 bash -c 'until curl -f http://localhost:5001/health; do sleep 2; done'
          echo "Presidio is ready!"

      - name: Run Regression Tests
        run: |
          cd apps/backend
          go run cmd/regression/main.go
        env:
          PRESIDIO_URL: http://localhost:5001

      - name: Check Quality Gate
        run: |
          echo "âœ… Regression tests passed with F1 >= 0.90"
          echo "Quality gate enforced successfully"
